<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-5CDP19RY2Z"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-5CDP19RY2Z');
    </script>
    <meta content="Marco Polo Research Lab" name="author"/>
    <link href="https://allergies.mprlab.com/" rel="canonical"/>
    <meta content="index,follow" name="robots"/>

    <!-- Inline PNG “allergy wheel” favicon (truncated for brevity) -->
    <link href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAA..." rel="icon" type="image/png"/>
    <link href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAA..." rel="shortcut icon" type="image/png"/>

    <title>Allergy Wheel</title>
    <meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport"/>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #fffbef;
            --fg: #111;
            --primary: #ff4d6d;
            --ink: #fff;
            --danger: #ff3b30;
            --success: #2ecc71;
            --card: #fff;
            --muted: #666;
            --shadow: 0 12px 30px rgba(0, 0, 0, .15)
        }

        html, body { height: 100% }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--fg);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            display: flex;
            flex-direction: column
        }

        header {
            position: relative;
            z-index: 50;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: linear-gradient(90deg, #fff0d6, #ffe5f0);
            border-bottom: 2px solid #ffd6e3
        }

        header h1 { margin: 0; font-size: clamp(18px, 2.2vw, 28px) }
        .header-right { display: flex; align-items: center; gap: 12px; }

        .ghost {
            background: #fff;
            border: 2px solid #000;
            border-radius: 999px;
            padding: 10px 14px;
            font-weight: 800;
            box-shadow: 2px 2px 0 #000;
            cursor: pointer
        }

        /* Hearts bar */
        .hearts {
            position: relative; /* required for delta bubble positioning */
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: clamp(18px, 2.5vw, 28px);
            line-height: 1;
            padding: 6px 10px;
            background: #fff7c8;
            border: 2px solid #000;
            border-radius: 999px;
            box-shadow: 2px 2px 0 #000;
        }

        .heart {
            display: inline-block;
            transform-origin: center;
            filter: drop-shadow(1px 1px 0 #000);
        }

        /* pop-in for new hearts */
        .heart-enter {
            animation: heart-pop-in 300ms ease-out forwards;
        }
        @keyframes heart-pop-in {
            0% { transform: scale(0); opacity: 0; }
            60% { transform: scale(1.25); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* pop-out for removed hearts */
        .heart-exit {
            animation: heart-pop-out 260ms ease-in forwards;
        }
        @keyframes heart-pop-out {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0); opacity: 0; }
        }

        /* Floating +1 / -1 */
        .heart-delta {
            position: absolute;
            right: -6px;
            top: -6px;
            font-weight: 900;
            text-shadow: 1px 1px 0 #000;
            animation: delta-float 800ms ease-out forwards;
            color: #000;
        }
        @keyframes delta-float {
            0% { transform: translateY(0) scale(0.9); opacity: 0; }
            10% { opacity: 1; }
            60% { transform: translateY(-12px) scale(1.05); }
            100% { transform: translateY(-22px) scale(1); opacity: 0; }
        }

        main { flex: 1; display: grid; place-items: center; padding: 20px }

        .card {
            width: min(900px, 92vw);
            background: var(--card);
            border-radius: 18px;
            box-shadow: var(--shadow);
            padding: 20px
        }

        .title { margin: 0 0 10px 0; font-size: clamp(22px, 3.4vw, 34px) }
        .muted { color: var(--muted) }
        .actions { margin-top: 12px }

        /* Base buttons */
        .btn { border: 0; border-radius: 999px; padding: 12px 18px; font-weight: 800; cursor: pointer }
        .btn.primary { background: var(--primary); color: var(--ink); box-shadow: var(--shadow) }
        .btn.danger { background: var(--danger); color: #fff; box-shadow: 4px 6px 0 #000; border: 4px solid #000 }

        /* Unified center action button */
        .btn.action { color: #fff; border: 4px solid #000; box-shadow: 4px 6px 0 #000; font-weight: 900; }
        .btn.action.is-start { background: var(--success); }
        .btn.action.is-stop { background: var(--danger); }

        .grid { display: grid; gap: 12px }
        .grid.cols-2 { grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)) }

        .chip {
            display: flex; align-items: center; gap: 10px;
            padding: 12px 14px; border-radius: 999px;
            background: #fff7c8; border: 2px solid #000; box-shadow: 2px 2px 0 #000
        }
        .chip input { width: 20px; height: 20px }

        /* Exclusive screens */
        #screen-allergy, #screen-wheel { display: none }
        body[data-screen="allergy"] #screen-allergy { display: grid }
        body[data-screen="wheel"] #screen-wheel { display: grid }

        /* Reveal overlay only on wheel screen */
        #reveal {
            position: fixed; inset: 0; background: rgba(0, 0, 0, .5);
            display: none; place-items: center; z-index: 10
        }
        body[data-screen="wheel"] #reveal[aria-hidden="false"] { display: grid }

        /* Game Over overlay */
        #gameover { position: fixed; inset: 0; background: rgba(0,0,0,.6); display: none; place-items: center; z-index: 20; }
        #gameover[aria-hidden="false"] { display: grid; }

        .wheel-wrap { position: relative; width: min(96vmin, 980px); aspect-ratio: 1; display: grid; place-items: center; margin-inline: auto }
        #wheel {
            width: 100%; height: 100%; background: #fff; border-radius: 50%;
            border: 6px solid #000; box-shadow: var(--shadow)
        }
        #stop {
            position: absolute; inset: auto auto 50% 50%; transform: translate(-50%, 50%);
            padding: 22px 34px; border-radius: 999px; font-weight: 900; font-size: clamp(18px, 2.6vw, 28px)
        }

        .status { text-align: center; margin-top: 12px; font-weight: 700 }
        .badge { display: inline-block; padding: 6px 10px; border-radius: 999px; background: #ffe08a; border: 2px solid #000; margin: 2px 6px; font-weight: 800 }

        .reveal-card {
            width: min(760px, 92vw); background: #fff; border-radius: 24px;
            border: 4px solid #000; box-shadow: var(--shadow); padding: 20px
        }

        .row { display: flex; justify-content: space-between; align-items: center; gap: 14px }
        .tag { background: #d1f7ff; border: 2px solid #000; border-radius: 14px; padding: 6px 10px; font-weight: 800 }

        .ingredients { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px }
        .ingredient { padding: 8px 12px; border: 2px solid #000; border-radius: 999px; background: #f4f4f4; font-weight: 700 }
        .ingredient.bad { background: #ffd0d6 }

        .banner { display: flex; align-items: center; gap: 12px; margin-top: 12px; border: 3px dashed #000; border-radius: 16px; padding: 10px }
        .ok { background: #d9fbe9 }
        .bad { background: #ffe2e6 }

        .face { width: 90px; height: 90px }
    </style>
</head>

<body data-screen="allergy">
<header>
    <h1>Allergy Wheel</h1>
    <div class="header-right">
        <div aria-live="polite" class="hearts" id="hearts-bar" title="Hearts"></div>
        <button class="ghost" id="fs">Full Screen</button>
    </div>
</header>

<!-- Allergy selection -->
<main id="screen-allergy">
    <div class="card">
        <h2 class="title">Pick your allergens</h2>
        <p class="muted">Choose anything that might cause trouble. You can change this later.</p>
        <div class="grid cols-2" id="allergy-list"></div>
        <div class="actions">
            <button class="btn primary" disabled id="start">Spin the Wheel</button>
        </div>
        <p class="muted" id="loading">Loading data…</p>
        <p class="muted" hidden id="load-error">Could not load data. Check JSON paths.</p>
    </div>
</main>

<!-- Wheel -->
<main id="screen-wheel">
    <div class="wheel-wrap">
        <canvas aria-label="Spinning dish wheel" height="1000" id="wheel" width="1000"></canvas>
        <!-- unified action button; JS toggles .is-stop <-> .is-start -->
        <button class="btn action is-stop" id="stop">STOP</button>
    </div>
    <div class="status">Allergens: <span id="sel-badges"></span></div>
</main>

<!-- Reveal -->
<section aria-hidden="true" aria-labelledby="dish-title" aria-modal="true" id="reveal" role="dialog">
    <div class="reveal-card">
        <div class="row">
            <h3 class="title" id="dish-title" style="margin:0"></h3>
            <span class="tag" id="dish-cuisine"></span>
        </div>
        <div class="banner ok" id="result">
            <svg class="face" hidden id="face" viewBox="0 0 100 100">
                <circle cx="50" cy="50" fill="#ffd1dc" r="45" stroke="#000" stroke-width="4"/>
                <circle cx="35" cy="40" r="6"/>
                <circle cx="65" cy="40" r="6"/>
                <ellipse cx="50" cy="65" fill="#ff9eb3" rx="22" ry="14" stroke="#000" stroke-width="4"/>
            </svg>
            <div id="result-text" style="font-weight:900"></div>
        </div>
        <div class="ingredients" id="dish-ingredients"></div>
        <div class="actions" style="text-align:right">
            <button class="btn primary" id="again">Spin Again</button>
        </div>
    </div>
</section>

<section aria-hidden="true" aria-labelledby="gameover-title" aria-modal="true" id="gameover" role="dialog">
    <div class="reveal-card" style="text-align:center">
        <h3 class="title" id="gameover-title" style="margin:0 0 6px 0">Game Over</h3>
        <p class="muted" style="margin:0 0 16px 0">You ran out of hearts. Want to try again?</p>
        <div class="actions" style="display:flex; gap:10px; justify-content:center">
            <button class="btn primary" id="restart">Restart</button>
        </div>
    </div>
</section>

<script src="app.js" type="module"></script>
</body>
</html>
